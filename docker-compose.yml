version: "3.8"

services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: inventory-db
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=${DB_PASSWORD:-YourStrongPassword123!}
      - MSSQL_PID=Developer
    ports:
      - "1433:1433"
    volumes:
      - sqlserver_data:/var/opt/mssql
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$${MSSQL_SA_PASSWORD}" -C -Q "SELECT 1" || exit 1
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  db-init:
    image: mcr.microsoft.com/mssql-tools:latest
    container_name: inventory-db-init
    depends_on:
      sqlserver:
        condition: service_healthy
    environment:
      - DB_SERVER=sqlserver
      - DB_PORT=1433
      - DB_USER=sa
      - DB_PASSWORD=${DB_PASSWORD:-YourStrongPassword123!}
      - DB_NAME=${DB_NAME:-InventoryDB}
    volumes:
      - ./database:/database:ro
      - ./scripts:/scripts:ro
    entrypoint: /bin/bash
    command: >
      -c "
        echo '[OK] Starting database initialization...'
        
        echo '[OK] Creating database if not exists...'
        /opt/mssql-tools18/bin/sqlcmd -S sqlserver,1433 -U sa -P '$$DB_PASSWORD' -C -Q \"
          IF NOT EXISTS (SELECT name FROM sys.databases WHERE name = N'$$DB_NAME')
          BEGIN
            CREATE DATABASE [$$DB_NAME];
            PRINT 'Database created';
          END
          ELSE PRINT 'Database exists';
        \"
        
        echo '[OK] Running migrations...'
        for file in /database/0[1-5]*.sql; do
          echo \"[OK] Running: $$(basename $$file)\"
          /opt/mssql-tools18/bin/sqlcmd -S sqlserver,1433 -U sa -P '$$DB_PASSWORD' -d '$$DB_NAME' -C -i \"$$file\"
        done
        
        echo '[OK] Database initialization complete!'
      "

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: inventory-app
    depends_on:
      db-init:
        condition: service_completed_successfully
    environment:
      - DB_SERVER=sqlserver
      - DB_PORT=1433
      - DB_USER=sa
      - DB_PASSWORD=${DB_PASSWORD:-YourStrongPassword123!}
      - DB_NAME=${DB_NAME:-InventoryDB}
      - DB_ENCRYPT=false
      - DB_TRUST_SERVER_CERTIFICATE=true
    ports:
      - "3000:3000"

volumes:
  sqlserver_data:
